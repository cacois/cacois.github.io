<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Codehenge - Who built it, and why? A blog about software, technology, and more</title>
    <meta name="description" content="Codehenge" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/pygments.css">

</head>
<body class="post-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="/ ">Home</a>
        <a class="subscribe-button icon-feed" href="/rss.xml">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Android Development Tutorial: Asynchronous Lazy Loading and Caching of ListView Images</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2011-06-15">15 Jun 2011</time>
                
                    on android, open source, and programming
                
            </section>
        </header>

<!--         <header class="post-header">
            <a id="blog-logo" href="blog url">
                
                    <img src="true" alt="Codehenge" />
                
            </a>
        </header> -->

        <!-- <span class="post-meta">
            <time datetime="2011-06-15">15 Jun 2011</time>
            
                on android, open source, and programming
            
        </span> -->

        <!-- <h1 class="post-title">Android Development Tutorial: Asynchronous Lazy Loading and Caching of ListView Images</h1> -->

        <section class="post-content">
            <p>In my</p>
<p><a href="http://codehenge.net/blog/2011/05/android-programming-tutorial-a-simple-twitter-feed-reader/">last post</a> I created a simple Android Twitter feed reader based on the <a href="http://search.twitter.com/api/">Twitter Search API</a>, demonstrating an application of custom ListView layouts and integration of internet data sources. Any readers who tried out the code would immediately notice that, though functional, the implementation produced significant lag in the UI when scrolling through the tweets. This is because the getView() method of a ListView adapter can be called one or more times each time a ListView item comes into view - we are given no guarantees on when or how this method will be called. Therefore, downloading the Twitter profile images within getView() was extremely inefficient, as each image was being downloaded by the UI thread as the ListView item came into view, and was usually downloaded repeatedly after that. Today I'll refactor the Twitter example to add asynchronous lazy loading and caching of images (Twitter profile images, in our case). Some of the code included has been based on the excellent</p>
<p><a href="https://github.com/thest1/LazyList">demonstration</a> provided by Github user <a href="https://github.com/thest1">thest1</a>. Through this example, I'll demonstrate asynchronous operations in Android, using local storage for caching data, ViewHolders, and a few other advanced techniques for optimizing app performance. First, let's recall where we left off last time. We were using a custom ArrayAdapter to set the view components of each item in our custom ListView:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TweetItemAdapter</span> <span class="kd">extends</span> <span class="n">ArrayAdapter</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="n">tweets</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">TweetItemAdapter</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">textViewResourceId</span><span class="o">,</span>
                                          <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="n">tweets</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">textViewResourceId</span><span class="o">,</span> <span class="n">tweets</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">tweets</span> <span class="o">=</span> <span class="n">tweets</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">convertView</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">LayoutInflater</span> <span class="n">vi</span> <span class="o">=</span>
         <span class="o">(</span><span class="n">LayoutInflater</span><span class="o">)</span><span class="n">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LAYOUT_INFLATER_SERVICE</span><span class="o">);</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">listitem</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">Tweet</span> <span class="n">tweet</span> <span class="o">=</span> <span class="n">tweets</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tweet</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">TextView</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">username</span><span class="o">);</span>
      <span class="n">TextView</span> <span class="n">message</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
      <span class="n">ImageView</span> <span class="n">image</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">avatar</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">username</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">username</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="na">username</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span><span class="o">(</span><span class="n">message</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span><span class="o">(</span><span class="n">image</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">image</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">getBitmap</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="na">image_url</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
</div>
<p>Each time getView() was called, a method getBitmap(url) was initiated, which reached out to the web to pull down the image required:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Bitmap</span> <span class="nf">getBitmap</span><span class="o">(</span><span class="n">String</span> <span class="n">bitmapUrl</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="n">bitmapUrl</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeStream</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span><span class="k">return</span> <span class="kc">null</span><span class="o">;}</span>
<span class="o">}</span></code></pre></div></div>
<p>Since all of this is happening on the UI thread, massive UI lag resulted, which would create a poor user experience for a production app. The root problems are:</p>
<ol>
<li>Images are being downloaded from the UI thread</li>
<li>Images are being downloaded many, many more times than they need to be, since getView() is called as often as Android feels like calling it</li>
</ol>
<p>So, what can we do?</p>
<p>First, Problem #1. The obvious solution is to download the image and set it to the ImageView in a separate thread. Easy, right? This is the first thing every developer tries when they encounter this problem. Unfortunately, its not so simple. The Android UI is absolutely, completely,</p>
<p><a href="http://developer.android.com/resources/articles/painless-threading.html">not thread-safe</a>. So, calling the ImageView in a worker thread could lead to your <a href="http://www.kongregate.com/games/mike_id/doom-1">DOOM</a>. Ok, ok...it could lead to weird bugs that are tough to track down. Either way, undesirable. Additionally, if we have a lot of tweets in our ListView, we may end up downloading a large number of profile images that our user never scrolls down to see, wasting network data usage and battery power, two things we want to minimize use of in mobile apps. The best solution to this issue is to lazy load the images in a separate thread, while placing them in our ImageViews with the main UI thread. A good solution is to cache the images somewhere the UI thread can access them, and let the UI thread know when they are available for display. This approach has the added benefit of addressing Problem #2, as well as our inefficient network/battery use, by downloading each image once and storing it in a local cache.</p>
<p>To start, we'll be adding a class to manage both our local image cache and a download queue for the images. Let's call this class ImageManager, and get it started:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ImageManager</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">&gt;</span> <span class="n">imageMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">&gt;();</span>
  <span class="kd">private</span> <span class="n">File</span> <span class="n">cacheDir</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">ImageManager</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Make background thread low priority, to avoid affecting UI performance</span>
    <span class="n">imageLoaderThread</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
    <span class="c1">// Find the dir to save cached images</span>
    <span class="n">String</span> <span class="n">sdState</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Environment</span><span class="o">.</span><span class="na">getExternalStorageState</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sdState</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Environment</span><span class="o">.</span><span class="na">MEDIA_MOUNTED</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">File</span> <span class="n">sdDir</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">();</span>
      <span class="n">cacheDir</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">sdDir</span><span class="o">,</span><span class="s">&quot;data/codehenge&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span>
      <span class="n">cacheDir</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getCacheDir</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">cacheDir</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span>
      <span class="n">cacheDir</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div></div>
<p>I've added the first things we know we will need, which are a map (imageMap) to store images for display, and reference to the directory where the longer-term image cache will be stored. In the constructor, find this directory by querying the device to see if external storage is mounted, and if not, by getting the default cache location. If we are using external storage (e.g. an SD card), we create a directory called "data/codehenge" for our app's cache.</p>
<p>Now we will need a few classes to manage a proper queue of images for download. For each image put into the queue, we need to know the URL to find it at, and we will eventually need to know the ImageView to put it in. Here'a an ImageRef class to take care of that:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ImageRef</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">url</span><span class="o">;</span>
  <span class="kd">public</span> <span class="n">ImageView</span> <span class="n">imageView</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">ImageRef</span><span class="o">(</span><span class="n">String</span> <span class="n">u</span><span class="o">,</span> <span class="n">ImageView</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">url</span><span class="o">=</span><span class="n">u</span><span class="o">;</span>
    <span class="n">imageView</span><span class="o">=</span><span class="n">i</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
</div>
<p>I'm making this a private class in my ImageManager class, but you could separate it out if you wanted to. For the actual queue, I'm using a stack of ImageRef objects. However, I'm wrapping this in its own class so I can add extra functionality. Because we know getView() can be called arbitrarily and often, for now I'll add the ability to clear all ImageRef objects from the queue that are pointing to a given ImageView, so we don't get too bottled up.</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ImageQueue</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">Stack</span><span class="o">&lt;</span><span class="n">imageref</span><span class="o">&gt;</span> <span class="n">imageRefs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Stack</span><span class="o">&lt;</span><span class="n">imageref</span><span class="o">&gt;();</span>
  <span class="c1">//removes all instances of this ImageView</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">Clean</span><span class="o">(</span><span class="n">ImageView</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">imageRefs</span><span class="o">.</span><span class="na">size</span><span class="o">();)</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(</span><span class="n">imageRefs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">imageView</span> <span class="o">==</span> <span class="n">view</span><span class="o">)</span>
        <span class="n">imageRefs</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="k">else</span> <span class="o">++</span><span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
</div>
<p>We need a way to add images to the queue, so let's write a small queueImage() method:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">queueImage</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">ImageView</span> <span class="n">imageView</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// This ImageView might have been used for other images, so we clear</span>
  <span class="c1">// the queue of old tasks before starting.</span>
  <span class="n">imageQueue</span><span class="o">.</span><span class="na">Clean</span><span class="o">(</span><span class="n">imageView</span><span class="o">);</span>
  <span class="n">ImageRef</span> <span class="n">p</span><span class="o">=</span><span class="k">new</span> <span class="nf">ImageRef</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">imageView</span><span class="o">);</span>
  <span class="kd">synchronized</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
    <span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="c1">// Start thread if it&#39;s not started yet</span>
  <span class="k">if</span><span class="o">(</span><span class="n">imageLoaderThread</span><span class="o">.</span><span class="na">getState</span><span class="o">()</span> <span class="o">==</span> <span class="n">Thread</span><span class="o">.</span><span class="na">State</span><span class="o">.</span><span class="na">NEW</span><span class="o">)</span>
    <span class="n">imageLoaderThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>
</div>
<p>Using the method above we're able to push an imageRef for an image into the queue (remember to lock this action!) and start the background imageLoaderThread, if it isn't already started.</p>
<p>Now we're ready to start some asynchronous coding. Basically, we need a thread to run in the background, watch the queue, and get images (either from our semi-persistent cache, or by downloading them) as they are queued. For this, let's create an ImageQueueManager class:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ImageQueueManager</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Thread waits until there are images in the</span>
        <span class="c1">// queue to be retrieved</span>
        <span class="k">if</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">synchronized</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// When we have images to be loaded</span>
        <span class="k">if</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">ImageRef</span> <span class="n">imageToLoad</span><span class="o">;</span>
          <span class="kd">synchronized</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">imageToLoad</span> <span class="o">=</span> <span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">getBitmap</span><span class="o">(</span><span class="n">imageToLoad</span><span class="o">.</span><span class="na">url</span><span class="o">);</span>
          <span class="n">imageMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">imageToLoad</span><span class="o">.</span><span class="na">url</span><span class="o">,</span> <span class="n">bmp</span><span class="o">);</span>
          <span class="c1">// TODO: Display image in ListView on UI thread</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div></div>
<p>This is a big one, but not too complex. Basically, this class is meant to run as a single background thread, so its implementing the Runnable interface and overriding its run() method. When run, this thread process will loop until interrupted, waiting for an image to show up in the queue. When an image is queued, it pops each imageRef from the stack in turn and calls getBitmap() (which we have yet to define) to get an Bitmap object, puts the image in our map, and will, once we define it, fire off a process on the UI thread to display the image in the ListView. I've put a TODO comment here, we'll come back to it in a little bit.</p>
<p>For now, we know what getBitmap() needs to do, so let's define it:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">getBitmap</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
  <span class="n">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">cacheDir</span><span class="o">,</span> <span class="n">filename</span><span class="o">);</span>
  <span class="c1">// Is the bitmap in our cache?</span>
  <span class="n">Bitmap</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeFile</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
  <span class="k">if</span><span class="o">(</span><span class="n">bitmap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">bitmap</span><span class="o">;</span>
  <span class="c1">// Nope, have to download it</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">bitmap</span> <span class="o">=</span>
      <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeStream</span><span class="o">(</span><span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">openConnection</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">());</span>
    <span class="c1">// save bitmap to cache for later</span>
    <span class="n">writeFile</span><span class="o">(</span><span class="n">bitmap</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">bitmap</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeFile</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">bmp</span><span class="o">,</span> <span class="n">File</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">FileOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FileOutputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="n">bmp</span><span class="o">.</span><span class="na">compress</span><span class="o">(</span><span class="n">Bitmap</span><span class="o">.</span><span class="na">CompressFormat</span><span class="o">.</span><span class="na">PNG</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> <span class="o">}</span>
  <span class="k">finally</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">out</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span> <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div></div>
<p>If you remember my last tutorial, some of this will look familiar. Namely, I have taken the BitmapFactory code straight out of the custom TweetItemAdapter and dropped it here, with some added functionality around it. Now, if we have the bitmap file cached locally, get it from there. If not, we use BitmapFactory to download it, and write it to the cache for next time. Note that in the writeFile() method we are compressing the bitmap into PNG format at 80% quality to save storage space and time. You can tweak this however you like, and check out the performance difference for your application.</p>
<p>We're now done with ImageManager, and can move on to integrating it with our UI components.</p>
<p>There are two paths we can take to display our image. First, if we have it sitting in our cache and available when getView() asks for it, we can just display it and move on. Alternatively, if we have to queue the download of the image, we need to be able to jump back into the UI thread as soon as the image is available to push it into view. Starting with the first path, let's look at an updated version of TweetItemAdapter:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TweetItemAdapter</span> <span class="kd">extends</span> <span class="n">ArrayAdapter</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="n">tweets</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="kd">public</span> <span class="n">ImageManager</span> <span class="n">imageManager</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">TweetItemAdapter</span><span class="o">(</span><span class="n">Activity</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">textViewResourceId</span><span class="o">,</span>
                                          <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="n">tweets</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">textViewResourceId</span><span class="o">,</span> <span class="n">tweets</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">tweets</span> <span class="o">=</span> <span class="n">tweets</span><span class="o">;</span>
    <span class="n">activity</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
    <span class="n">imageManager</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">ImageManager</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ViewHolder</span><span class="o">{</span>
    <span class="kd">public</span> <span class="n">TextView</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">TextView</span> <span class="n">message</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">ImageView</span> <span class="n">image</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">convertView</span><span class="o">;</span>
    <span class="n">ViewHolder</span> <span class="n">holder</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">LayoutInflater</span> <span class="n">vi</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutInflater</span><span class="o">)</span> <span class="n">activity</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LAYOUT</span><span class="err">\</span><span class="n">_INFLATER</span><span class="err">\</span><span class="n">_SERVICE</span><span class="o">);</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">listitem</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ViewHolder</span><span class="o">();</span>
      <span class="n">holder</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">username</span><span class="o">);</span>
      <span class="n">holder</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
      <span class="n">holder</span><span class="o">.</span><span class="na">image</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">avatar</span><span class="o">);</span>
      <span class="n">v</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="n">holder</span><span class="o">=(</span><span class="n">ViewHolder</span><span class="o">)</span><span class="n">v</span><span class="o">.</span><span class="na">getTag</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">Tweet</span> <span class="n">tweet</span> <span class="o">=</span> <span class="n">tweets</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tweet</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">holder</span><span class="o">.</span><span class="na">username</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="na">username</span><span class="o">);</span>
      <span class="n">holder</span><span class="o">.</span><span class="na">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
      <span class="n">holder</span><span class="o">.</span><span class="na">image</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="na">image_url</span><span class="o">);</span>
      <span class="n">imageManager</span><span class="o">.</span><span class="na">displayImage</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="na">image_url</span><span class="o">,</span> <span class="n">activity</span><span class="o">,</span> <span class="n">holder</span><span class="o">.</span><span class="na">image</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
</div>
<p>There are a few changes to this class since<a href="">last time</a>, but nothing severe. Out adapter now needs an instance of our ImageManager, and it also needs a reference to its Activity object, which you'll recall has to be passed to the ImageManager when it displays an image. We've also introduced the usage of a ViewHolder, which is a handy tool that optimizes performance a bit. Using a ViewHolder basically means we don't have to call findViewById for every single view, every time we want it, which adds up to a decent amount of computational savings. For some more information on ViewHolders and why you want to use them, check out <a href="http://www.screaming-penguin.com/node/7767">this post</a> by Charlie Collins. You'll also notice that when initially populating the View for a given Tweet, I now set the tag of the ImageView to the url of the image to be displayed. We'll use this later to verify that we are setting the image in the correct ImageView. Look at the end of getView() and you'll see where we address the "display the image immediately is possible" path. When we have both a Tweet object and a View that are not null, we call a method called displayImage() through the ImageManager:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">displayImage</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="n">ImageView</span> <span class="n">imageView</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span><span class="o">(</span><span class="n">imageMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">url</span><span class="o">))</span>
    <span class="n">imageView</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">imageMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
  <span class="k">else</span> <span class="o">{</span>
    <span class="n">queueImage</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">imageView</span><span class="o">);</span>
    <span class="n">imageView</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div> This is the place where we set the bitmap immediately if it is in our imageMap, or push it into our queue and instead put a placeholder there. The placeholder, R.drawable.icon, is a default Android icon you will probably find automatically included in your project. The reason for the placeholder is that we expect this method to be invoked anytime getView() is called, whether or not the image has been downloaded yet. So, if it hasn't, the placeholder will be displayed until we have a proper Twitter avatar. If you like, you can make this placeholder a different image, a blank image, or nothing at all.</p>
<p>Now we need address our second path by writing some code to display the bitmap in the ListView, using the UI thread. As before, this is easily implemented as a class using the Runnable interface, like so:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Used to display bitmap in the UI thread</span>
<span class="kd">private</span> <span class="kd">class</span> <span class="nc">BitmapDisplayer</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
  <span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">;</span>
  <span class="n">ImageView</span> <span class="n">imageView</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">BitmapDisplayer</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">b</span><span class="o">,</span> <span class="n">ImageView</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">bitmap</span><span class="o">=</span><span class="n">b</span><span class="o">;</span>
    <span class="n">imageView</span><span class="o">=</span><span class="n">i</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">bitmap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
      <span class="n">imageView</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
    <span class="k">else</span>
      <span class="n">imageView</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
</div>
<p>Now we have a class that can be run on a thread, that is instantiated with a bitmap and an ImageView it needs to be displayed in, whose run() method sets in the ImageView or replaces it with a placeholder image. Let's add this into the space we left for it in ImageQueueManager:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ImageQueueManager</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Thread waits until there are images in the</span>
        <span class="c1">// queue to be retrieved</span>
        <span class="k">if</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">synchronized</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// When we have images to be loaded</span>
        <span class="k">if</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">ImageRef</span> <span class="n">imageToLoad</span><span class="o">;</span>
          <span class="kd">synchronized</span><span class="o">(</span><span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">imageToLoad</span> <span class="o">=</span> <span class="n">imageQueue</span><span class="o">.</span><span class="na">imageRefs</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">Bitmap</span> <span class="n">bmp</span> <span class="o">=</span> <span class="n">getBitmap</span><span class="o">(</span><span class="n">imageToLoad</span><span class="o">.</span><span class="na">url</span><span class="o">);</span>
          <span class="n">imageMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">imageToLoad</span><span class="o">.</span><span class="na">url</span><span class="o">,</span> <span class="n">bmp</span><span class="o">);</span>
          <span class="n">Object</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">imageToLoad</span><span class="o">.</span><span class="na">imageView</span><span class="o">.</span><span class="na">getTag</span><span class="o">();</span>
          <span class="c1">// Make sure we have the right view - thread safety defender</span>
          <span class="k">if</span><span class="o">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">tag</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="n">imageToLoad</span><span class="o">.</span><span class="na">url</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">BitmapDisplayer</span> <span class="n">bmpDisplayer</span> <span class="o">=</span>
              <span class="k">new</span> <span class="nf">BitmapDisplayer</span><span class="o">(</span><span class="n">bmp</span><span class="o">,</span> <span class="n">imageToLoad</span><span class="o">.</span><span class="na">imageView</span><span class="o">);</span>
            <span class="n">Activity</span> <span class="n">a</span> <span class="o">=</span>
              <span class="o">(</span><span class="n">Activity</span><span class="o">)</span><span class="n">imageToLoad</span><span class="o">.</span><span class="na">imageView</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
            <span class="n">a</span><span class="o">.</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="n">bmpDisplayer</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div></div>
<p>The ImageQueueManager class is now complete. Remember, when we have images in the queue, we get the bitmap from cache or download, then put it in our map. Now we continue by checking the tag to verify the bitmap we have belongs in this ImageView, create a new BitmapDisplayer object, get the activity from the ImageView, and use it to run the BitmapDisplayer operations in the UI thread. Notice the check of the ImageView tag: This allows us to be absolutely certain that we are putting the bitmap we have into the ImageView that wants it, which is basically our last stand against the inexplicable behavior of ListViews and getView().</p>
<p>Last, but not least, is our Activity class, which remains basically unchanged from the previous tutorial. Here it is, for the sake of completeness:</p>
<div>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="n">tweets</span> <span class="o">=</span> <span class="n">getTweets</span><span class="o">(</span><span class="s">&quot;android&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">ListView</span> <span class="n">listView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ListView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">ListViewId</span><span class="o">);</span>
    <span class="n">listView</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="k">new</span> <span class="nf">TweetItemAdapter</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">listitem</span><span class="o">,</span> <span class="n">tweets</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="nf">getTweets</span><span class="o">(</span><span class="n">String</span> <span class="n">searchTerm</span><span class="o">,</span> <span class="kt">int</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">searchUrl</span> <span class="o">=</span> <span class="s">&quot;http://search.twitter.com/search.json?q=@&quot;</span> <span class="o">+</span> <span class="n">searchTerm</span> <span class="o">+</span> <span class="s">&quot;&amp;rpp=25&amp;page=&quot;</span> <span class="o">+</span> <span class="n">page</span><span class="o">;</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;</span> <span class="n">tweets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">tweet</span><span class="o">&gt;();</span>
    <span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span>  <span class="nf">DefaultHttpClient</span><span class="o">();</span>
    <span class="n">HttpGet</span> <span class="n">get</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HttpGet</span><span class="o">(</span><span class="n">searchUrl</span><span class="o">);</span>
    <span class="n">ResponseHandler</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">responseHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BasicResponseHandler</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">responseBody</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">get</span><span class="o">,</span> <span class="n">responseHandler</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">JSONParser</span> <span class="n">parser</span><span class="o">=</span><span class="k">new</span> <span class="nf">JSONParser</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">responseBody</span><span class="o">);</span>
      <span class="n">jsonObject</span><span class="o">=(</span><span class="n">JSONObject</span><span class="o">)</span><span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;TEST&quot;</span><span class="o">,</span><span class="s">&quot;Exception: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">JSONArray</span> <span class="n">arr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">Object</span> <span class="n">j</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;results&quot;</span><span class="o">);</span>
      <span class="n">arr</span> <span class="o">=</span> <span class="o">(</span><span class="n">JSONArray</span><span class="o">)</span><span class="n">j</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;TEST&quot;</span><span class="o">,</span><span class="s">&quot;Exception: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">for</span><span class="o">(</span><span class="n">Object</span> <span class="n">t</span> <span class="o">:</span> <span class="n">arr</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Tweet</span> <span class="n">tweet</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Tweet</span><span class="o">(</span>
        <span class="o">((</span><span class="n">JSONObject</span><span class="o">)</span><span class="n">t</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;from_user&quot;</span><span class="o">).</span><span class="na">toString</span><span class="o">(),</span>
        <span class="o">((</span><span class="n">JSONObject</span><span class="o">)</span><span class="n">t</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;text&quot;</span><span class="o">).</span><span class="na">toString</span><span class="o">(),</span>
        <span class="o">((</span><span class="n">JSONObject</span><span class="o">)</span><span class="n">t</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;profile_image_url&quot;</span><span class="o">).</span><span class="na">toString</span><span class="o">()</span>
      <span class="o">);</span>
      <span class="n">tweets</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tweet</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">tweets</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="cm">/** Classes **/</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tweet</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="kd">public</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span> <span class="kd">public</span> <span class="n">String</span> <span class="n">image_url</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Tweet</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">image_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
</div>
<p>And we're done! The code is complete, and ready to run. You will see a notable increase in UI responsiveness, and should really not notice any lag at all unless you swipe through a large list at warp speed.</p>
<p>I've put the full project from this tutorial up on</p>
<p><a href="https://github.com/cacois/TweetView">Github</a>, so go ahead and grab it, fork it, try it out for yourself. Happy coding!</p>
<p><strong>Get 50% off my Node.js course <a href="http://search.twitter.com/api/">here</a></strong></p>
<p>If you liked this article, help me out by sharing a 50% discount to my Node.js course here: <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.udemy.com/learn-nodejs-by-example/?couponCode=codehenge" data-text="Sign up for Learn Node.js by Example now and get 50% off!" data-via="AaronCois" data-size="large" data-hashtags="nodejs">Tweet</a> Thanks!</p>
<p>You should follow me on Twitter here: <a href="https://twitter.com/AaronCois" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @AaronCois</a></p>

        </section>

        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            
                <figure class="author-image">
                    <a class="img" href="/ " style="background-image: url(/assets/images/profile2.jpg)">
                    <span class="hidden">Constantine Aaron Cois's Picture</span></a>
                </figure>
                <section class="author">
                    <!-- Author Name -->
                    <h4> Constantine Aaron Cois </h4>
                    <!-- Author Bio -->
                    <p>
                         I code, I teach, I write. Want to know more <a href='/about.html'> about me? </a> 
                    </p>
                </section>
            

            <!-- Share links section -->
            <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=Android Development Tutorial: Asynchronous Lazy Loading and Caching of ListView Images&amp;url=http://www.codehenge.net/2011/06/15/android-development-tutorial-asynchronous-lazy-loading-and-caching-of-listview-images/"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.codehenge.net/2011/06/15/android-development-tutorial-asynchronous-lazy-loading-and-caching-of-listview-images/"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://www.codehenge.net/2011/06/15/android-development-tutorial-asynchronous-lazy-loading-and-caching-of-listview-images/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

            <!-- Disqus comments -->
            

        </footer>

    </article>

</main>

    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="/">Codehenge</a> &copy;
               &bull; All rights reserved.
      </section>
      <section class="poweredby">Made with Jekyll using
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>

    <script type="text/javascript" src="/assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-XXXXXXXX-X']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
